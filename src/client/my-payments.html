<!DOCTYPE html>
<html>
<head>
    <title>My Payments - Splitta.io</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        /* Estilos adicionales para mejorar la experiencia m√≥vil */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .p-6 {
                padding: 1rem !important;
            }
            
            .text-3xl {
                font-size: 1.5rem;
            }
            
            .max-w-4xl {
                max-width: 100%;
            }
            
            .flex.space-x-4 {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .flex.space-x-4 a {
                width: 100%;
                text-align: center;
            }
            
            .grid.grid-cols-1.md\\:grid-cols-2 {
                grid-template-columns: 1fr;
            }
        }
        
        /* Mejoras para interacci√≥n t√°ctil */
        @media (hover: none) and (pointer: coarse) {
            button, a {
                min-height: 44px;
            }
            
            button:active, a:active {
                transform: scale(0.95);
                transition: transform 0.1s ease;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-600 to-purple-700 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">üí∞ My Payments</h1>
                    <div class="flex space-x-4">
                        <a href="/add-funds.html" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                            ‚ûï New Payment
                        </a>
                        <a href="/" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-colors">
                            üéÆ Back to Game
                        </a>
                    </div>
                </div>
                
                <div id="paymentsList" class="space-y-4">
                    <div class="text-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                        <p class="mt-2 text-gray-600">Loading payments...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Configurar la URL base de la API
        const API_BASE_URL = 'https://usa.backspitta.xyz';
        
        // Funci√≥n para obtener el estado del pago
        async function checkPaymentStatus(paymentId) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/payment-status?payment_id=${paymentId}`, {
                    method: 'GET',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    return data.status;
                } else {
                    return 'error';
                }
            } catch (error) {
                console.error('Error checking payment status:', error);
                return 'error';
            }
        }
        
        // Funci√≥n para actualizar el estado de un pago
        async function updatePaymentStatus(paymentId, statusElement) {
            const originalText = statusElement.textContent;
            statusElement.textContent = 'Checking...';
            statusElement.className = 'px-2 py-1 rounded text-xs font-medium bg-yellow-100 text-yellow-800';
            
            try {
                const newStatus = await checkPaymentStatus(paymentId);
                
                // Actualizar el estado en la base de datos
                await fetch(`${API_BASE_URL}/api/update-payment-status`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ payment_id: paymentId, status: newStatus }),
                    credentials: 'include'
                });
                
                // Actualizar la UI
                statusElement.textContent = newStatus;
                
                if (newStatus === 'finished') {
                    statusElement.className = 'px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-800';
                    // Recargar la p√°gina despu√©s de 2 segundos si el pago est√° completado
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else if (newStatus === 'waiting' || newStatus === 'confirming') {
                    statusElement.className = 'px-2 py-1 rounded text-xs font-medium bg-yellow-100 text-yellow-800';
                } else if (newStatus === 'failed' || newStatus === 'expired') {
                    statusElement.className = 'px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-800';
                } else {
                    statusElement.className = 'px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-800';
                }
            } catch (error) {
                console.error('Error updating payment status:', error);
                statusElement.textContent = originalText;
                statusElement.className = 'px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-800';
            }
        }
        
        // Funci√≥n para generar QR code
        function generateQRCode(container, data) {
            container.innerHTML = '';
            new QRCode(container, {
                text: data,
                width: 120,
                height: 120,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
        }
        
        // Funci√≥n para formatear fecha
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString();
        }
        
        // Funci√≥n para obtener el color del estado
        function getStatusColor(status) {
            switch (status) {
                case 'finished':
                    return 'bg-green-100 text-green-800';
                case 'waiting':
                case 'confirming':
                    return 'bg-yellow-100 text-yellow-800';
                case 'failed':
                case 'expired':
                    return 'bg-red-100 text-red-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        }
        
        // Funci√≥n para obtener el icono del estado
        function getStatusIcon(status) {
            switch (status) {
                case 'finished':
                    return '‚úÖ';
                case 'waiting':
                    return '‚è≥';
                case 'confirming':
                    return 'üîÑ';
                case 'failed':
                    return '‚ùå';
                case 'expired':
                    return '‚è∞';
                default:
                    return '‚ùì';
            }
        }
        
        // Cargar pagos del usuario
        async function loadPayments() {
            try {
                console.log('[MY-PAYMENTS] Cargando pagos del usuario...');
                const response = await fetch(`${API_BASE_URL}/api/user-payments`, {
                    method: 'GET',
                    credentials: 'include'
                });
                
                console.log('[MY-PAYMENTS] Respuesta recibida:', response.status, response.statusText);
                
                const data = await response.json();
                console.log('[MY-PAYMENTS] Datos recibidos:', data);
                
                if (data.success) {
                    const paymentsList = document.getElementById('paymentsList');
                    
                    if (data.payments.length === 0) {
                        paymentsList.innerHTML = `
                            <div class="text-center py-8">
                                <div class="text-6xl mb-4">üí≥</div>
                                <h3 class="text-xl font-semibold text-gray-800 mb-2">No payments found</h3>
                                <p class="text-gray-600 mb-4">You haven't made any payments yet.</p>
                                <a href="/add-funds.html" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg transition-colors">
                                    Make Your First Payment
                                </a>
                            </div>
                        `;
                        return;
                    }
                    
                    console.log('[MY-PAYMENTS] Renderizando', data.payments.length, 'pagos');
                    
                    paymentsList.innerHTML = data.payments.map(payment => `
                        <div class="border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-800">
                                        Payment #${payment.id}
                                    </h3>
                                    <p class="text-sm text-gray-600">
                                        Created: ${formatDate(payment.createdAt)}
                                    </p>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="px-2 py-1 rounded text-xs font-medium ${getStatusColor(payment.status)}">
                                        ${getStatusIcon(payment.status)} ${payment.status}
                                    </span>
                                    <button onclick="updatePaymentStatus('${payment.id}', this.previousElementSibling)" 
                                            class="text-blue-600 hover:text-blue-800 text-sm">
                                        üîÑ
                                    </button>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <h4 class="font-semibold text-gray-700 mb-2">Payment Details</h4>
                                    <div class="space-y-1 text-sm">
                                        <p><strong>Amount:</strong> $${payment.amount} USD</p>
                                        <p><strong>Crypto:</strong> ${payment.payCurrency.toUpperCase()}</p>
                                        <p><strong>Pay Amount:</strong> ${payment.payAmount} ${payment.payCurrency.toUpperCase()}</p>
                                        <p><strong>Address:</strong> <code class="bg-gray-100 px-1 rounded text-xs">${payment.payAddress}</code></p>
                                    </div>
                                </div>
                                
                                <div>
                                    <h4 class="font-semibold text-gray-700 mb-2">QR Code</h4>
                                    <div id="qr-${payment.id}" class="flex justify-center"></div>
                                </div>
                            </div>
                            
                            <div class="mt-4 pt-4 border-t border-gray-200">
                                <p class="text-xs text-gray-600">
                                    <strong>Order ID:</strong> ${payment.orderId}
                                </p>
                                <div class="mt-2">
                                    <button onclick="testPayment('${payment.id}')" class="bg-purple-600 text-white px-3 py-1 rounded text-xs hover:bg-purple-700 transition-colors">
                                        üß™ Test Payment
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    
                    // Generar QR codes para cada pago
                    data.payments.forEach(payment => {
                        const qrContainer = document.getElementById(`qr-${payment.id}`);
                        if (qrContainer && payment.payAddress) {
                            const qrData = `${payment.payCurrency}:${payment.payAddress}?amount=${payment.payAmount}`;
                            generateQRCode(qrContainer, qrData);
                        }
                    });
                } else {
                    console.error('[MY-PAYMENTS] Error en la respuesta:', data.error);
                    document.getElementById('paymentsList').innerHTML = `
                        <div class="text-center py-8">
                            <div class="text-6xl mb-4">‚ùå</div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">Error loading payments</h3>
                            <p class="text-gray-600">${data.error}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('[MY-PAYMENTS] Error loading payments:', error);
                document.getElementById('paymentsList').innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-6xl mb-4">‚ùå</div>
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">Error loading payments</h3>
                        <p class="text-gray-600">Please try again later.</p>
                    </div>
                `;
            }
        }
        
        // Funci√≥n para probar pago
        async function testPayment(paymentId) {
            if (!confirm('¬øQuieres simular que este pago se complet√≥? Esto agregar√° los fondos a tu balance.')) {
                return;
            }
            
            try {
                console.log('[MY-PAYMENTS] Simulando pago:', paymentId);
                const response = await fetch(`${API_BASE_URL}/api/test-payment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ payment_id: paymentId }),
                    credentials: 'include'
                });
                
                const data = await response.json();
                console.log('[MY-PAYMENTS] Respuesta del test:', data);
                
                if (data.success) {
                    alert('‚úÖ Pago simulado completado!\nNuevo balance: $' + data.newBalance + ' USD\n\nSer√°s redirigido al juego.');
                    setTimeout(() => {
                        window.location.href = '/?payment=success';
                    }, 2000);
                } else {
                    alert('‚ùå Error: ' + data.error);
                }
            } catch (error) {
                console.error('[MY-PAYMENTS] Error testing payment:', error);
                alert('‚ùå Error al simular pago');
            }
        }
        
        // Cargar pagos al cargar la p√°gina
        loadPayments();
    </script>
</body>
</html>
