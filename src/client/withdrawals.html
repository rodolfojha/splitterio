<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retiros - Splitta</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>        
        .button {
          color: #ff9900;
          font-size: 17px;
          background-color: transparent; /* naranja brillante base */
          border: 4px solid #ff9900;
          border-radius: 115px;
          cursor: pointer;
          padding: 10px;
          box-shadow: 0px 6px 0px #cc7a00;
          transition: all 0.1s ease-in-out;
          font-weight: bold;
        }

        button.inactive {
          color: #FFF;
          font-size: 17px;
          background-color: transparent;
          border: 4px solid #858585;
          border-radius: 115px;
          padding: 10px 50px;
          box-shadow: 0px 6px 0px #5E5E5E;
          font-weight: bold;
        }

        button.selected {
          color: #000;
          background-color: #ffd24d; /* amarillo c√°lido */
          border-color: #ffb300;
        }

        .button:hover {
          box-shadow: 0px 4px 0px #cc7a00;
          position: relative;
          background: rgba(255, 168, 0, 0.15);
          top: 1px;
        }

        .button:active {
          box-shadow: 0px 2px 0px #cc7a00;
          position: relative;
          top: 2px;
        }

        button:hover.selected {
          box-shadow: 0px 4px 0px #cc7a00;
          background-color: #ffcc33;
          top: 1px;
        }

        button:active.selected {
          box-shadow: 0px 2px 0px #cc7a00;
          top: 2px;
        }

        button:hover.inactive {
          box-shadow: 0px 4px 0px #5E5E5E;
          background: rgba(255, 255, 255, 0.05);
          top: 1px;
        }

        button:active.inactive {
          box-shadow: 0px 2px 0px #5E5E5E;
          top: 2px;
        }
        .loader-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100vw;
          height: 100vh;
          background-color: rgba(255, 255, 255, 0.8);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 9999;
          transition: opacity 0.3s ease;
        }

        .loader-overlay.hidden {
          opacity: 0;
          pointer-events: none;
        }

        .loader {
          border: 5px solid #f3f3f3;
          border-top: 5px solid #ffd24d;
          border-radius: 50%;
          width: 60px;
          height: 60px;
          animation: spin 1s linear infinite;
        }

        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        } 
        .roundedorange{
          color: #ff9900;
          font-size: 17px;
          margin: inherit;
          background-color: transparent; /* naranja brillante base */
          border: 4px solid #ff9900;
          padding: 10px;
          box-shadow: 0px 6px 0px #cc7a00;
          transition: all 0.1s ease-in-out;
          font-weight: bold;
        }        
        @media (max-width: 768px) {
            .bg-gray-800 {
                padding: 1rem !important;
            }
            
            .p-8 {
                padding: 1rem !important;
            }
            
            .text-3xl {
                font-size: 1.5rem;
            }
            
            .max-w-4xl {
                max-width: 100%;
            }
            
            .flex-col.md\\:flex-row {
                flex-direction: column;
            }
            
            .gap-6 {
                gap: 1rem;
            }
        }
        
        /* Mejoras para interacci√≥n t√°ctil */
        @media (hover: none) and (pointer: coarse) {
            button, select, input {
                min-height: 44px;
            }
            
            button:active {
                transform: scale(0.95);
                transition: transform 0.1s ease;
            }
        }
          /* Dropdown personalizado */
        .dropdown {
          position: relative;
          width: 100%;
        }
        .dropdown-content {
          display: none;
          position: absolute;
          width: 100%;
          max-height: 250px;
          overflow-y: auto;
          background-color: #1f2937; /* bg-gray-800 */
          border: 1px solid #4b5563; /* border-gray-600 */
          border-radius: 0.75rem; /* rounded-xl */
          z-index: 50;
          box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        .dropdown-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 0.75rem 1rem;
          cursor: pointer;
          transition: background 0.2s;
        }
        .dropdown-item:hover {
          background-color: #2563eb; /* azul hover */
        }
    </style>
    
</head>
<body class="bg-gray-900 text-gray-200 min-h-screen flex items-center justify-center p-6">
    <div class="loader-overlay" id="loader">
      <div class="loader"></div>
    </div>

    <div class="w-full max-w-2xl bg-gray-800 rounded-2xl shadow-lg p-6">
        <div class="text-center mb-6">
            <h1 class="text-2xl font-bold">Cash Outs</h1>
            <p class="text-gray-400 text-sm">Cash out your earnings to your choosen wallet</p>
        </div>

        <!-- Balance -->
        <div class="bg-gray-700 rounded-xl p-4 text-center mb-6">
            <p class="text-lg text-gray-300">Current Balance <p>
            <p id="userBalance" class="text-3xl font-bold text-[#ffd24d]">$0.00</p>
        </div>

        <!-- Crear Retiro -->
        <div id="alertContainer" class="mb-3"></div>
        <form id="withdrawalForm" class="space-y-5">
            <div>
                <label class="block text-sm font-medium mb-2 text-gray-300" id="amountLabel">Amount (USD)</label>
                <input id="amountInput" type="number" id="amount" min="2" step="0.01" value="2"
                    class="w-full p-4 bg-gray-700 border border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent text-gray-100 placeholder-gray-400 transition">
            </div>
            <div class="rounded-xl roundedorange">
              <p class="font-bold mb-1">üí° Low Fees:</p>
              <p>Choose <span class="uppercase font-semibold">USDT / USDC MATIC</span> for lower transaction fees and minimun deposits!</p>
            </div>
            
            <label class="block text-sm font-medium mb-2">Select Network</label>
            <select id="networkSelect" class="w-full p-3 rounded-xl bg-gray-800 border border-gray-600 mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="Polygon">Polygon/MATIC</option>
              <option value="BSC">BSC</option>
              <option value="TRON">TRON</option>
              <option value="Ethereum">Ethereum</option>
              <option value="Solana">Solana</option>
              <option value="Arbitrum">Arbitrum</option>
              <option value="Optimism">Optimism</option>
              <option value="TON">TON</option>
              <option value="Other">Other</option>
            </select>
            <label for="cryptoInput" class="block text-sm font-medium mb-2">Select Cryptocurrency</label>
            <div class="dropdown">
              <input type="text" id="cryptoInput" placeholder="Buscar..." value="USDTMATIC" class="w-full p-3 rounded-xl bg-gray-800 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
              <div id="cryptoDropdown" class="dropdown-content"></div>
            </div>
            <input type="hidden" id="selectedCrypto">
            <div>
                <label class="block text-sm font-medium mb-2 text-gray-300" id="amountLabel">Wallet Address</label>
                <input id="walletInput" required type="text"
                    class="w-full p-4 bg-gray-700 border border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent text-gray-100 placeholder-gray-400 transition">
            </div>

            <div id="estimateInfo" class="hidden p-4 bg-gray-700 border border-gray-600 rounded-xl">
                <div class="text-sm text-gray-200 space-y-1">
                    <div class="flex justify-between">
                        <span>You'll receive:</span>
                        <span id="estimatedAmount" class="font-medium text-blue-400">0.0000</span>
                    </div>
                    <div class="flex justify-between text-gray-400">
                        <span>Rate:</span>
                        <span id="exchangeRate">1 USD = 0.0000</span>
                    </div>
                    <div class="flex justify-between text-gray-400">
                        <span>Fee(NowPayments + Network):</span>
                        <span id="feeRate">0.0000</span>
                    </div>
                </div>
            </div>
            <div class="flex flex-col w-full gap-4">
                <button type="submit" id="submitBtn"
                    class="py-2 button w-full selected">
                    Process Cash Out
                </button>
                <a href="/" class="w-full button py-3 text-center"><!--mt-4 text-blue-500 hover:text-blue-700 block text-center w-full">-->
                    Back to Game
                </a>
            </div>
        </form>
    </div>

<script>
    let selectedCrypto = null;
    let currentBalance = 0;
    const API_BASE_URL = 'https://usa.backspitta.xyz';

    function hideLoader() {
      const loader = document.getElementById('loader');
      loader.classList.add('hidden');
      // Opcional: eliminar del DOM despu√©s de la animaci√≥n
      setTimeout(() => loader.remove(), 300);
    }
    document.addEventListener('DOMContentLoaded', () => {
        loadUserBalance().then(() => {
            hideLoader();
        });
        document.getElementById('withdrawalForm').addEventListener('submit', handleWithdrawal);
    });
    
    async function handleWithdrawal() {
        console.log("Haciendo withdrawal");
    }

    async function loadUserBalance() {
        try {
            const response = await fetch('/api/auth/status', { credentials: 'include' });
            const data = await response.json();
            if(!data.user){window.location.href = '/';};
            let balance = data.user?.balance ?? 0;
            balance = parseFloat(balance) || 0;
            currentBalance = balance;
            document.getElementById('userBalance').textContent = `$${balance.toFixed(2)}`;
        } catch {
            window.location.href = '/';
        }
    }

    function selectCrypto(symbol, element) {
        document.querySelectorAll('#cryptoGrid div').forEach(opt => opt.classList.remove('bg-green-500','text-black'));
        element.classList.add('bg-green-500','text-black');
        selectedCrypto = symbol;
    }
    
    document.getElementById('amountInput').addEventListener('input', updateEstimate);
    async function updateEstimate() {
        const amount = document.getElementById('amountInput').value;
        if (!amount) return;
        
        try {
            const response = await fetch(`${API_BASE_URL}/api/estimate-withdraw?amount=${amount}&crypto=${selectedCrypto}`, {
                method: 'GET',
                credentials: 'include'
            });
            
            const data = await response.json();
            
            if (data.success) {
                document.getElementById('estimateInfo').classList.remove('hidden');
                document.getElementById('estimatedAmount').textContent = data.estimated_amount + ' ' + selectedCrypto.toUpperCase();
                document.getElementById('exchangeRate').textContent = `1 USD = ${data.rate}`;
                document.getElementById('feeRate').textContent = `${data.fee} ${selectedCrypto.toUpperCase()}`;
            }
        } catch (error) {
            console.error('Error getting estimate:', error);
        }
    }
    async function handleWithdrawal(e) {
        e.preventDefault();
        const amount = parseFloat(document.getElementById('amountInput').value);
        const wallet = document.getElementById('walletInput').value.trim();

        if (!selectedCrypto) return showAlert('Selecciona una criptomoneda', 'red');
        if (amount > currentBalance) return showAlert('Balance insuficiente', 'red');
        if (amount > 50) return showAlert('Monto m√°ximo: $50', 'red');
        if (!wallet) return showAlert('Ingresa una wallet', 'red');
        
        /*TODO 
        confirmaci√≥n al usuario antes de mandar al backend mostrando billetera
        mandar verificaci√≥n de usuario a backend(tanto monto en BD como en nowpayments como no superado m√°ximo de 1 retiro diario)
        mostrar un "monto enviado correctamente tenga en cuenta que el saldo puede tardar hasta x minutos en llegar"
        
        */
    }

    async function loadWithdrawalHistory() {
        try {
            const res = await fetch('/api/user-withdrawals');
            if (res.ok) {
                const data = await res.json();
                const container = document.getElementById('withdrawalHistory');
                if (!data.withdrawals || data.withdrawals.length === 0) {
                    container.innerHTML = '<p class="text-center text-gray-500">No hay retiros</p>';
                    return;
                }
                container.innerHTML = data.withdrawals.map(w => `
                    <div class="flex justify-between bg-gray-700 rounded-md p-3">
                        <div>
                            <div class="font-semibold">$${w.amount} - ${w.crypto_currency.toUpperCase()}</div>
                            <div class="text-xs text-gray-400">${new Date(w.created_at).toLocaleString()}</div>
                        </div>
                        <div class="text-sm">${w.status}</div>
                    </div>
                `).join('');
            }
        } catch {}
    }

    function showAlert(msg, color) {
        const container = document.getElementById('alertContainer');
        container.innerHTML = `<div class="px-3 py-2 rounded-md bg-${color}-700 text-${color}-300 text-sm font-medium">${msg}</div>`;
        setTimeout(() => container.innerHTML = '', 4000);
    }
    const input = document.getElementById('cryptoInput');
    const dropdown = document.getElementById('cryptoDropdown');
    const hiddenInput = document.getElementById('selectedCrypto');
    const networkSelect = document.getElementById('networkSelect');

    let allCurrencies = [];

    // Mostrar dropdown al enfocar
    input.addEventListener('focus', () => dropdown.style.display = 'block');

    // Filtrar por buscador y por red
    input.addEventListener('input', filtrarDropdown);
    networkSelect.addEventListener('change', filtrarDropdown);

    function filtrarDropdown() {
      const search = input.value.toLowerCase();
      const networkFilter = networkSelect.value;
      dropdown.querySelectorAll('.dropdown-item').forEach(item => {
        const textMatch = item.textContent.toLowerCase().includes(search);
        const networkMatch = networkFilter === 'All' || item.dataset.network === networkFilter;
        item.style.display = (textMatch && networkMatch) ? 'flex' : 'none';
      });
    }

    // Ocultar dropdown al hacer click fuera
    document.addEventListener('click', e => {
      if (!e.target.closest('.dropdown')) dropdown.style.display = 'none';
    });

    // Cargar monedas
    async function cargarCryptos() {
      const nowRes = await fetch(`${API_BASE_URL}/api/currencies`, {
          method: 'GET',
          credentials: 'include'
      });
      const nowData = await nowRes.json();
      const nowCurrencies = nowData.currencies;

      const getNetwork = (currency) => {
        const name = currency.toLowerCase();
        if (name.includes('matic')) return 'Polygon';
        if (name.includes('bsc')) return 'BSC';
        if (name.includes('trc20')) return 'TRON';
        if (name.includes('erc20')) return 'Ethereum';
        if (name.includes('sol')) return 'Solana';
        if (name.includes('arb')) return 'Arbitrum';
        if (name.includes('op')) return 'Optimism';
        if (name.includes('ton')) return 'TON';
        return 'Other';
      };


      allCurrencies = nowCurrencies.map(c => ({
        ...c,
        network: getNetwork(c.currency)
      }));

      renderDropdown();
    }

    function renderDropdown() {
      dropdown.innerHTML = '';
      allCurrencies.forEach(c => {
        const div = document.createElement('div');
        div.className = 'dropdown-item uppercase';
        div.dataset.value = c.currency;
        div.dataset.network = c.network;

        const cur = c.currency.toUpperCase();

        // Destacar USDTMATIC y USDCMATIC
        let highlightStyle = '';
        let minAmount = c.min_amount || 0;
        if (cur === "USDTMATIC" || cur === "USDCMATIC") {
          c.min_amount = 5; // comisi√≥n m√≠nima
          minAmount = 5;
          if(cur === "USDTMATIC"){
              input.value = cur;
              hiddenInput.value = c.currency;
              selectedCrypto = cur.toLowerCase();
              dropdown.style.display = 'none';
              document.getElementById("amountInput").min = c.min_amount;
              document.getElementById("amountInput").value = c.min_amount;
              updateEstimate();
          }
          div.style = 'background-color: #948A00; color: white; font-weight: bold; border-radius: 0.5rem;';
        }else if((cur.includes("USDT") || cur.includes("USDC") || cur.includes("FDUSD")) && (cur.includes("BSC") || cur.includes("SOL"))){
          minAmount = 10;
          c.min_amount = 10;
        }else{
          minAmount = 20;
          c.min_amount = 20;
        }

        div.innerHTML = `
          <div class="flex items-center" style="${highlightStyle}">
            ${cur}
          </div>
          <span class="text-gray-300 text-sm">Min ${minAmount} USDT</span>
        `;

        div.addEventListener('click', () => {
          input.value = cur;
          hiddenInput.value = c.currency;
          selectedCrypto = cur.toLowerCase();
          dropdown.style.display = 'none';
          document.getElementById("amountInput").min = c.min_amount;
          document.getElementById("amountInput").value = c.min_amount;
          updateEstimate();
        });

        dropdown.appendChild(div);
      });
      filtrarDropdown();
    }

    // Inicializar
    cargarCryptos();
</script>
</body>
</html>
